# Story 1.4: autogen-core-integration

## Status
Draft

## Story
**As a** system architect,
**I want** Microsoft AutoGen core framework integrated with the Python backend,
**so that** agent conversation capabilities are available for individual agent implementations.

## Foundation Component
**DEPENDENCY**: Requires Story 1.1a (python-backend-setup) completion for FastAPI infrastructure.

## Acceptance Criteria
1. **AUTOGEN INSTALLATION**: Microsoft AutoGen 0.2+ installed and configured in Python backend
2. **CONVERSATION MANAGER**: Basic AutoGen conversation manager implemented with FastAPI integration
3. **AGENT FRAMEWORK**: Base agent classes established for Financial Analyst, Market Context, and Risk Challenger
4. **GROUP CHAT**: AutoGen GroupChat functionality configured for multi-agent conversations
5. **API ENDPOINTS**: FastAPI endpoints for initiating and managing AutoGen conversations
6. **ERROR HANDLING**: AutoGen conversation error handling integrated with existing monitoring
7. **PERFORMANCE**: AutoGen conversations optimized for 90-second completion target
8. **LOGGING**: AutoGen conversation logging integrated with existing Python backend logging
9. **TESTING**: AutoGen conversation testing framework with mock agents
10. **CONFIGURATION**: AutoGen model configuration (GPT-4) with API key management

## Tasks / Subtasks
- [ ] Install and configure AutoGen (AC: 1, 10)
  - [ ] Add AutoGen dependencies to requirements.txt
  - [ ] Configure OpenAI GPT-4 integration
  - [ ] Set up AutoGen logging and configuration
- [ ] Implement conversation manager (AC: 2, 4)
  - [ ] Create AutoGen conversation orchestrator
  - [ ] Configure GroupChat for multi-agent conversations
- [ ] Create base agent framework (AC: 3)
  - [ ] Design base ConversableAgent classes
  - [ ] Create agent factory patterns for three agent types
- [ ] Add FastAPI integration (AC: 5, 6, 8)
  - [ ] Create AutoGen conversation API endpoints
  - [ ] Integrate error handling and logging
- [ ] Optimize performance and testing (AC: 7, 9)
  - [ ] Implement 90-second conversation optimization
  - [ ] Create AutoGen testing framework with mocks

## Dev Notes

### AutoGen Core Installation
```python
# apps/backend/requirements.txt additions
autogen-agentchat>=0.2.0
autogen-ext[openai]>=0.2.0
openai>=1.0.0
```

### Base Agent Framework
```python
# apps/backend/app/agents/base_agent.py
from autogen_agentchat.agents import ConversableAgent
from autogen_ext.models.openai import OpenAIChatCompletionClient
from typing import Dict, Any, Optional

class BaseFinancialAgent(ConversableAgent):
    def __init__(
        self,
        name: str,
        system_message: str,
        model_config: Dict[str, Any],
        **kwargs
    ):
        model_client = OpenAIChatCompletionClient(
            model=model_config.get("model", "gpt-4-turbo"),
            api_key=model_config["api_key"]
        )

        super().__init__(
            name=name,
            model_client=model_client,
            system_message=system_message,
            **kwargs
        )

class FinancialAnalystAgent(BaseFinancialAgent):
    def __init__(self, model_config: Dict[str, Any]):
        super().__init__(
            name="FinancialAnalyst",
            system_message="You are a quantitative financial analyst...",
            model_config=model_config
        )

class MarketContextAgent(BaseFinancialAgent):
    def __init__(self, model_config: Dict[str, Any]):
        super().__init__(
            name="MarketContext",
            system_message="You provide real-time market intelligence...",
            model_config=model_config
        )

class RiskChallengerAgent(BaseFinancialAgent):
    def __init__(self, model_config: Dict[str, Any]):
        super().__init__(
            name="RiskChallenger",
            system_message="You systematically question analysis...",
            model_config=model_config
        )
```

### Conversation Manager Implementation
```python
# apps/backend/app/services/conversation_manager.py
from autogen_agentchat.teams import RoundRobinGroupChat
from autogen_agentchat.base import TaskResult
from typing import List, Dict, Any
import asyncio

class AutoGenConversationManager:
    def __init__(self, model_config: Dict[str, Any]):
        self.model_config = model_config
        self.agents = self._initialize_agents()

    def _initialize_agents(self):
        return [
            FinancialAnalystAgent(self.model_config),
            MarketContextAgent(self.model_config),
            RiskChallengerAgent(self.model_config)
        ]

    async def start_conversation(
        self,
        initial_message: str,
        max_turns: int = 6,
        timeout: int = 90
    ) -> TaskResult:
        """Start AutoGen conversation with timeout management."""

        group_chat = RoundRobinGroupChat(
            participants=self.agents,
            max_turns=max_turns
        )

        try:
            # Use asyncio timeout for 90-second completion target
            result = await asyncio.wait_for(
                group_chat.run(task=initial_message),
                timeout=timeout
            )
            return result

        except asyncio.TimeoutError:
            # Graceful timeout handling
            return self._handle_conversation_timeout()
        except Exception as e:
            # Error handling integrated with existing monitoring
            raise ConversationError(f"AutoGen conversation failed: {str(e)}")
```

### FastAPI Integration
```python
# apps/backend/app/api/routes/conversations.py
from fastapi import APIRouter, HTTPException, Depends
from app.services.conversation_manager import AutoGenConversationManager
from app.middleware.auth import get_current_user
from pydantic import BaseModel
from typing import Optional

router = APIRouter(prefix="/conversations", tags=["conversations"])

class ConversationRequest(BaseModel):
    message: str
    max_turns: Optional[int] = 6
    timeout: Optional[int] = 90

class ConversationResponse(BaseModel):
    conversation_id: str
    status: str
    messages: List[Dict]
    summary: Optional[str]
    duration: float

@router.post("/start", response_model=ConversationResponse)
async def start_conversation(
    request: ConversationRequest,
    user = Depends(get_current_user),
    conversation_manager = Depends(get_conversation_manager)
):
    """Start new AutoGen conversation."""
    try:
        result = await conversation_manager.start_conversation(
            initial_message=request.message,
            max_turns=request.max_turns,
            timeout=request.timeout
        )

        return ConversationResponse(
            conversation_id=generate_conversation_id(),
            status="completed",
            messages=result.messages,
            summary=result.summary,
            duration=result.duration
        )

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

### Key Constraints
- **DEPENDENCY**: Must wait for Story 1.1a (Python backend) completion
- **NO MCP INTEGRATION YET**: Story 1.1c will handle MCP bridge separately
- **PERFORMANCE**: 90-second conversation completion target
- **ERROR HANDLING**: Must integrate with existing monitoring patterns
- **TESTING**: Comprehensive mock framework for agent testing

### Testing Framework
```python
# apps/backend/tests/test_autogen_integration.py
import pytest
from unittest.mock import Mock, patch
from app.services.conversation_manager import AutoGenConversationManager

@pytest.fixture
def mock_conversation_manager():
    with patch('app.services.conversation_manager.ConversableAgent'):
        manager = AutoGenConversationManager({"model": "gpt-4", "api_key": "test"})
        return manager

@pytest.mark.asyncio
async def test_conversation_completion(mock_conversation_manager):
    """Test AutoGen conversation completes within timeout."""
    result = await mock_conversation_manager.start_conversation(
        "Test financial analysis",
        timeout=5  # Short timeout for testing
    )

    assert result is not None
    assert result.duration < 5.0

@pytest.mark.asyncio
async def test_conversation_timeout_handling(mock_conversation_manager):
    """Test graceful timeout handling."""
    with patch('asyncio.wait_for', side_effect=asyncio.TimeoutError):
        result = await mock_conversation_manager.start_conversation("Test")
        assert result.status == "timeout"
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-28 | 1.0 | Core AutoGen integration extracted from 1.1 for parallel development | Sarah (PO) |

## Dev Agent Record
_(This section is owned by dev-agent and can only be modified by dev-agent)_

## QA Results
_(This section is owned by qa-agent and can only be modified by qa-agent)_