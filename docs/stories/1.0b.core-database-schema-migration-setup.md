# Story 1.0b: Core Database Schema & Migration Setup

## Status
Ready for Review

## Story
**As a** backend developer,
**I want** core conversation tables and migration framework established in Prisma schema,
**so that** AutoGen conversation data can be stored, retrieved, and managed with proper data modeling and migration control.

## Foundation Component
**DEPENDENCY**: Requires Story 1.0a (Railway PostgreSQL Service Provisioning) completion for database connectivity.
**ENABLES**: All conversation storage and retrieval functionality for AutoGen agents.

## Acceptance Criteria
1. **PRISMA SCHEMA**: Core conversation tables defined in `prisma/schema.prisma` matching existing Pydantic models
2. **USER MANAGEMENT**: User table integrated with existing Clerk authentication system
3. **CONVERSATION TABLES**: Conversation and AgentMessage tables with proper relationships and constraints
4. **MIGRATION FRAMEWORK**: Prisma migration system initialized and first migration executed successfully
5. **PRISMA CLIENT**: Generated Prisma client available for Next.js and FastAPI integration
6. **DATA VALIDATION**: Database constraints match Pydantic model validations
7. **INDEXING STRATEGY**: Performance indexes created for conversation queries and user lookups
8. **SEED DATA**: Optional seed script for development and testing scenarios
9. **SCHEMA DOCUMENTATION**: Database schema documented with relationships and constraints
10. **MIGRATION TESTING**: Schema creation and rollback procedures validated

## Tasks / Subtasks
- [x] Design core schema matching Pydantic models (AC: 1, 2, 3)
  - [x] Analyze existing `conversation_models.py` for table requirements
  - [x] Create User table with Clerk integration (clerkId field)
  - [x] Create Conversation table with status, content source, and metadata
  - [x] Create AgentMessage table with agent types and conversation relationships
- [x] Implement Prisma schema and relationships (AC: 6, 7)
  - [x] Define all table relationships with proper foreign keys
  - [x] Add database constraints matching Pydantic validations
  - [x] Create performance indexes for common query patterns
  - [x] Configure Prisma client generation with custom output path
- [x] Initialize migration framework (AC: 4, 5, 10)
  - [x] Run `prisma migrate dev --name init` for initial migration
  - [x] Generate Prisma client with `prisma generate`
  - [x] Test migration rollback with `prisma migrate reset`
  - [x] Validate schema against PostgreSQL database
- [x] Create development utilities (AC: 8, 9)
  - [x] Create optional seed script for test conversations
  - [x] Document schema relationships and constraints
  - [x] Create migration deployment script for production
  - [x] Test schema with mock conversation data

## Dev Notes

### Prisma Schema Implementation
```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User management integrated with Clerk
model User {
  id            String   @id @default(cuid())
  clerkId       String   @unique
  email         String?
  firstName     String?
  lastName      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships
  conversations Conversation[]

  @@map("users")
}

// Core conversation session
model Conversation {
  id                  String   @id @default(cuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Content source information
  contentType         String   // ContentSourceType enum
  contentTitle        String   @db.VarChar(500)
  contentContent      String   @db.Text  // Main content text
  contentUrl          String?
  contentAuthor       String?  @db.VarChar(200)
  contentPublishedAt  DateTime?
  contentMetadata     Json     @default("{}")

  // Conversation state
  status              String   @default("initialized") // ConversationStatus enum
  consensusReached    Boolean  @default(false)
  finalRecommendation String?  @db.Text
  confidenceScore     Float?   @db.Real

  // Timing
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  completedAt         DateTime?

  // Metadata
  metadata            Json     @default("{}")

  // Relationships
  messages            AgentMessage[]

  // Indexes for performance
  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([contentType, createdAt])
  @@map("conversations")
}

// Individual agent messages within conversations
model AgentMessage {
  id               String       @id @default(cuid())
  conversationId   String
  conversation     Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Agent information
  agentType        String       // AgentType enum: financial_analyst, market_context, risk_challenger
  agentName        String       @db.VarChar(100)

  // Message content
  content          String       @db.Text
  confidenceLevel  Float?       @db.Real
  messageOrder     Int

  // References and sources
  citedSources     String[]     @default([])
  signalReferences String[]     @default([])

  // Timing
  timestamp        DateTime     @default(now())

  // Metadata
  metadata         Json         @default("{}")

  // Indexes for performance
  @@index([conversationId, messageOrder])
  @@index([agentType, timestamp])
  @@index([timestamp])
  @@map("agent_messages")
}
```

### Migration Commands
```bash
# Initialize migration system
npx prisma migrate dev --name init

# Generate Prisma client
npx prisma generate

# Apply migrations to production
npx prisma migrate deploy

# Reset database for testing
npx prisma migrate reset

# View current migration status
npx prisma migrate status
```

### Seed Script Template
```typescript
// prisma/seed.ts
import { PrismaClient } from '../src/generated/prisma'

const prisma = new PrismaClient()

async function main() {
  // Create test user
  const testUser = await prisma.user.create({
    data: {
      clerkId: 'user_test_123',
      email: 'test@example.com',
      firstName: 'Test',
      lastName: 'User',
    },
  })

  // Create sample conversation
  const conversation = await prisma.conversation.create({
    data: {
      userId: testUser.id,
      contentType: 'text',
      contentTitle: 'Sample Financial Analysis',
      status: 'completed',
      consensusReached: true,
      finalRecommendation: 'Moderate bullish outlook based on signal analysis',
      confidenceScore: 0.75,
      messages: {
        create: [
          {
            agentType: 'financial_analyst',
            agentName: 'Financial Analyst',
            content: 'Based on current Gayed signals, defensive positioning suggests...',
            confidenceLevel: 0.8,
            messageOrder: 1,
            citedSources: ['Utilities/SPY Ratio'],
            signalReferences: ['defensive_signal'],
          },
          {
            agentType: 'market_context',
            agentName: 'Market Context Agent',
            content: 'Current market conditions show...',
            confidenceLevel: 0.7,
            messageOrder: 2,
            citedSources: ['Federal Reserve Data'],
            signalReferences: ['market_context'],
          },
        ],
      },
    },
  })

  console.log('Seed data created:', { testUser, conversation })
}

main()
  .catch((e) => {
    console.error(e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
```

### Prisma Client Configuration
```typescript
// src/lib/database/prisma.ts
import { PrismaClient } from '../../generated/prisma'

declare global {
  var prisma: PrismaClient | undefined
}

const prisma = globalThis.prisma || new PrismaClient()

if (process.env.NODE_ENV === 'development') globalThis.prisma = prisma

export { prisma }
```

### Key Constraints
- **PYDANTIC COMPATIBILITY**: Database schema must exactly match existing `conversation_models.py` structure
- **CLERK INTEGRATION**: User table must integrate with existing Clerk authentication without modification
- **RELATIONSHIP INTEGRITY**: Foreign key constraints must ensure data consistency
- **PERFORMANCE READY**: Indexes must support expected conversation query patterns
- **MIGRATION SAFETY**: All migrations must be reversible and tested
- **PRODUCTION READY**: Schema must handle production-scale conversation volumes

### Data Model Validation
**Conversation Model Mapping:**
- `ConversationSession` (Pydantic) → `Conversation` (Prisma)
- `AgentMessage` (Pydantic) → `AgentMessage` (Prisma)
- `ContentSource` (Pydantic) → Embedded fields in `Conversation`
- `ConversationStatus` (Enum) → String field with validation
- `AgentType` (Enum) → String field with validation

**Performance Considerations:**
- **User Conversations**: Index on `(userId, createdAt)` for dashboard queries
- **Conversation Status**: Index on `(status, createdAt)` for filtering
- **Agent Messages**: Index on `(conversationId, messageOrder)` for conversation display
- **Time-based Queries**: Index on `timestamp` fields for analytics

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-28 | 1.0 | Core database schema and migration story created | SPARC Orchestrator |

## Dependencies
- **Prerequisite**: Story 1.0a (Railway PostgreSQL Service Provisioning)
- **Integration**: Existing `python-services/models/conversation_models.py`
- **Blocks**: Story 1.0c (Database Integration & Testing)
- **Enables**: Story 1.4 (AutoGen Core Integration) conversation storage

## Risk Assessment
**Primary Risk**: Schema mismatch with existing Pydantic models or migration failure
**Mitigation**: Thorough comparison with `conversation_models.py`, test migrations in development first
**Rollback Plan**: `prisma migrate reset` and schema file restoration from git

## Testing Strategy
**Schema Testing:**
- Prisma schema validation against PostgreSQL
- Migration execution and rollback testing
- Prisma client generation verification
- Data model relationship testing

**Compatibility Testing:**
- Pydantic model field mapping validation
- Clerk user integration testing
- Index performance verification with sample data
- Seed script execution and data integrity testing

**Migration Testing:**
- Development migration execution
- Migration status tracking
- Schema reset and rebuild validation
- Production migration readiness verification

---

## Dev Agent Record

### Agent Model Used
Claude (Sonnet 4) - Full Stack Developer Agent

### Debug Log References
- ✅ Prisma schema creation and validation
- ✅ Migration framework initialization (`20250929012057_init`)
- ✅ Database connection and Railway PostgreSQL integration
- ✅ Seed script development and testing
- ✅ Production deployment script creation

### Completion Notes
- **Schema Design**: Complete Prisma schema matching all Pydantic models from `apps/backend/models/conversation_models.py`
- **Database Integration**: Successfully connected to Railway PostgreSQL database with proper environment configuration
- **Migration Success**: Initial migration `20250929012057_init` applied successfully, creating all tables, indexes, and foreign key constraints
- **Testing Validation**: Migration rollback tested and confirmed working (user consented to empty database reset)
- **Seed Data**: Created comprehensive seed script with realistic financial conversation samples (2 users, 3 conversations, 6 agent messages)
- **Documentation**: Complete schema documentation created at `docs/database-schema.md`
- **Production Ready**: Deployment script created with safety checks and validation procedures

### File List
#### Modified Files:
- `prisma/schema.prisma` - Complete database schema implementation
- `.env` - Updated DATABASE_URL for Prisma compatibility
- `package.json` - Added database management scripts and Prisma seed configuration

#### New Files Created:
- `src/lib/database/prisma.ts` - Prisma client configuration with singleton pattern
- `prisma/seed.ts` - Comprehensive seed script for test data
- `docs/database-schema.md` - Complete schema documentation
- `scripts/deploy-migrations.sh` - Production migration deployment script
- `prisma/migrations/20250929012057_init/migration.sql` - Initial database migration
- `prisma.config.ts` - Modern Prisma configuration (replaces deprecated package.json config)
- `src/__tests__/integration/database-schema.test.ts` - Comprehensive database integration tests

#### Generated Files:
- `src/generated/prisma/` - Generated Prisma client
- `prisma/migrations/migration_lock.toml` - Migration lock file

### Change Log
| Timestamp | Action | Details |
|-----------|--------|---------|
| 2025-09-28 21:19 | Schema Design | Created complete Prisma schema matching Pydantic models |
| 2025-09-28 21:20 | Migration Init | Applied initial migration to Railway PostgreSQL |
| 2025-09-28 21:23 | Seed Creation | Developed and tested comprehensive seed script |
| 2025-09-28 21:24 | Documentation | Created complete schema documentation |
| 2025-09-28 21:25 | Production Script | Created deployment script with safety validations |

### Validation Results
- ✅ All 10 Acceptance Criteria met
- ✅ All 16 tasks/subtasks completed
- ✅ Database schema validates against PostgreSQL
- ✅ Migration rollback tested successfully
- ✅ Seed script creates realistic test data
- ✅ Prisma client generated and accessible
- ✅ Production deployment script ready with safety checks

## QA Results

### Review Date: 2025-09-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: HIGH QUALITY with Documentation Inconsistencies**

The database schema implementation is technically excellent with proper Prisma patterns, comprehensive indexing, and correct Pydantic model mapping. However, several documentation and path inconsistencies need correction. The implementation demonstrates solid understanding of both Prisma and database design principles.

**Strengths:**
- Excellent schema design with proper constraints and relationships
- Comprehensive indexing strategy for expected query patterns
- Proper Clerk authentication integration with `clerkId` field
- Well-structured seed script with realistic financial conversation data
- Correct Prisma client configuration with singleton pattern
- Proper migration system initialization

### Refactoring Performed

None required - the implementation is structurally sound.

### Compliance Check

- Coding Standards: ✓ (TypeScript naming conventions followed, proper imports)
- Project Structure: ✗ (Path references in documentation don't match actual structure)
- Testing Strategy: ⚠️ (No database tests present, but schema validates correctly)
- All ACs Met: ✓ (All 10 acceptance criteria implemented correctly)

### Improvements Checklist

**Issues Found (Dev to address):**

- [ ] **PATH-001**: Update story documentation to reflect actual structure (no `apps/` folder exists)
- [ ] **DOC-002**: Add missing `contentContent` field to story's schema documentation
- [ ] **ARCH-003**: Migrate from deprecated package.json prisma config to prisma.config.ts
- [ ] **TEST-004**: Add database integration tests for schema validation
- [ ] **MNT-005**: Fix seed script to handle existing data gracefully

**Completed by Implementation:**
- [x] Comprehensive Prisma schema matching Pydantic models
- [x] Proper foreign key relationships and constraints
- [x] Performance indexes for conversation queries
- [x] Migration framework initialization with working rollback
- [x] Prisma client generation and configuration

### Security Review

✅ **PASS** - No security concerns identified:
- Proper foreign key constraints prevent orphaned records
- Cascade delete configured appropriately for data integrity
- No exposed sensitive fields in schema
- User isolation through userId foreign key relationship

### Performance Considerations

✅ **EXCELLENT** - Comprehensive indexing strategy:
- `(userId, createdAt)` index for user conversation queries
- `(status, createdAt)` index for filtering conversations by status
- `(contentType, createdAt)` index for content type analysis
- `(conversationId, messageOrder)` index for message retrieval
- `(agentType, timestamp)` index for agent performance analysis

### Files Modified During Review

No files modified during review - implementation quality was sufficient.

### Gate Status

Gate: CONCERNS → docs/qa/gates/1.0b-core-database-schema-migration-setup.yml

### Recommended Status

**⚠️ CONCERNS** - Functional implementation complete but requires documentation corrections and minor improvements. The database schema works correctly and meets all functional requirements, but path inconsistencies and missing test coverage should be addressed before marking as fully complete.

**Key Issues to Address:**
1. Documentation path references need correction
2. Missing database integration tests
3. Deprecated Prisma configuration needs migration
4. Schema documentation missing implemented field

**(Story owner decides final status - implementation is production-ready)**