# Story 1.8: multi-agent-conversation

## Status
Draft

## Story
**As a** financial professional,
**I want** the three AutoGen agents to engage in structured conversations,
**so that** I receive comprehensive analysis through transparent agent debates.

## Acceptance Criteria
1. AutoGen conversation orchestrator manages structured debates between the three financial agents
2. Conversation flow ensures each agent contributes specialized expertise in logical sequence
3. Agents can respond to and build upon each other's analysis within single conversation
4. Conversation termination logic prevents infinite loops while ensuring thorough analysis
5. Agent debates produce actionable consensus with clear reasoning trail
6. Conversation quality maintained through existing performance monitoring and validation
7. Debates complete within reasonable timeframe (target: 90 seconds) for user experience
8. Agent conversations logged and accessible through existing session management
9. Conversation outcomes integrate with existing consensus calculation and dashboard display
10. Error handling ensures graceful degradation if individual agents fail during conversation

## Tasks / Subtasks
- [ ] Implement conversation orchestrator (AC: 1, 2)
  - [ ] Create NEW AutoGen conversation orchestrator (separate from SignalOrchestrator)
  - [ ] Design structured debate flow management using AutoGen conversation patterns
  - [ ] Ensure logical sequence of agent contributions (Financial → Context → Risk → Consensus)
- [ ] Enable inter-agent communication (AC: 3)
  - [ ] Implement agent response and building capabilities
  - [ ] Design conversation context sharing
- [ ] Implement conversation control (AC: 4, 7)
  - [ ] Add termination logic to prevent infinite loops
  - [ ] Optimize for 90-second completion target
- [ ] Develop consensus generation (AC: 5, 9)
  - [ ] Create actionable consensus from agent debates (DIFFERENT from signal consensus)
  - [ ] Agent conversation consensus: summary of debate conclusions and reasoning
  - [ ] Display alongside (not replace) existing SignalOrchestrator consensus calculation
  - [ ] Two types: Signal consensus (quantitative) + Agent consensus (qualitative reasoning)
- [ ] Integrate with existing systems (AC: 6, 8)
  - [ ] Connect to performance monitoring
  - [ ] Implement conversation logging via session management
- [ ] Add error handling and resilience (AC: 10)
  - [ ] Graceful degradation for agent failures
  - [ ] Fallback mechanisms for conversation issues

## Dev Notes

### Relevant Source Tree Info
- `src/domains/trading-signals/engines/orchestrator.ts` - Signal orchestration (REFERENCE, not extend)
- New: AutoGen conversation orchestrator (separate implementation)
- Session management and logging systems (existing)
- Performance monitoring infrastructure (existing)
- Dashboard display components for conversation results (existing/enhanced)

### Conversation Flow Design
Structured debate flow should:
1. Financial Analyst provides quantitative analysis
2. Market Context agent adds economic context
3. Risk Challenger questions and provides alternatives
4. Iterative refinement based on cross-agent feedback
5. Consensus generation with clear reasoning trail

### Performance Requirements
- Target: 90-second completion for user experience
- Conversation quality maintained through monitoring
- Graceful degradation if agents fail
- Efficient context sharing between agents

### Integration Approach
Leverage existing orchestration patterns while adding AutoGen-specific conversation management. Must integrate seamlessly with current dashboard and session systems.

**EVENT-DRIVEN ARCHITECTURE: Breaking Circular Dependencies**
1. **Signal Orchestration** (`SignalOrchestrator`): Coordinates Gayed signal calculations
   - Handles quantitative signal aggregation (utilities/SPY, lumber/gold, etc.)
   - Produces numerical consensus (Risk-On/Risk-Off/Mixed)
   - PRESERVED AS-IS - no modification

2. **Agent Conversation Orchestration** (NEW): Event-driven AutoGen coordination
   - **SUBSCRIBES** to "content_ready" events from content processing
   - **PUBLISHES** "conversation_started", "agent_message", "conversation_complete" events
   - **REACTIVE PATTERN**: No direct dependencies on content processing systems
   - Built using AutoGen conversation management patterns
   - Consumes signal orchestrator results as input

**Event-Driven Architecture Pattern:**
```
Content Processing → "content_ready" event → Event Bus → AutoGen Orchestrator
                                                            ↓
SignalOrchestrator → Quantitative Data → Event Payload → Agent Conversations
                                                            ↓
WebSocket Events ← "agent_message" events ← Event Bus ← Conversation Results
       ↓
   Dashboard Display (Real-time updates)
```

### Key Constraints
- Must complete within 90 seconds for good UX
- Conversation quality must be maintained
- Error handling for individual agent failures
- Integration with existing consensus and dashboard systems
- **CRITICAL**: Do NOT modify existing SignalOrchestrator - create separate system
- Agent conversations consume signal data but produce separate reasoning consensus
- Two consensus types: Signal consensus (quantitative) + Agent consensus (qualitative)
- Maintain financial-grade data integrity - no fallback data in agent conversations

### Testing
**Testing Standards:**
- End-to-end conversation flow tests with all three agents
- Performance tests for 90-second completion target
- Error handling and graceful degradation tests
- Integration tests with existing SignalOrchestrator (READ-ONLY access)
- Conversation quality and consensus generation validation
- **Separation tests**: Verify signal orchestration unaffected by agent conversations
- **Dual consensus tests**: Validate both signal + agent consensus display correctly

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-21 | 1.0 | Initial story creation | John (PM) |
| 2025-01-28 | 1.1 | Clarified orchestration separation and dual consensus approach | Sarah (PO) |

## Dev Agent Record
_(This section is owned by dev-agent and can only be modified by dev-agent)_

## QA Results
_(This section is owned by qa-agent and can only be modified by qa-agent)_