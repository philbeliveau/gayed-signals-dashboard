# Story 2.4: direct-text-input

## Status
Draft

## Story
**As a** financial analyst,
**I want** to paste research reports or market commentary directly,
**so that** AutoGen agents can analyze any financial text content for immediate debate.

## Acceptance Criteria
1. Direct text input interface added to existing dashboard UI using current component patterns
2. Text content validation ensures financial relevance using existing content filtering capabilities
3. Input processing leverages existing API infrastructure and authentication systems
4. Text content prepared for AutoGen agent analysis using current content formatting utilities
5. Content storage and session management using existing database and caching infrastructure
6. Input validation prevents malicious content and ensures appropriate length limits
7. Text processing integrates with existing error handling and user feedback systems
8. Content analysis triggers AutoGen debates with current market signal context
9. Direct input maintains existing security measures and user session management
10. Processed text formatted optimally for financial agent conversation and analysis
11. **DEPENDENCY**: Epic 1.1 AutoGen framework integration - **STATUS: Approved** ✅
12. **DEPENDENCY**: AutoGen conversation orchestrator from Epic 1.5 - **STATUS: Approved** ✅

## Tasks / Subtasks
- [ ] Add direct text input UI (AC: 1)
  - [ ] Create text input component using existing patterns
  - [ ] Integrate with current dashboard UI
- [ ] Implement content validation (AC: 2, 6)
  - [ ] Add financial relevance validation
  - [ ] Implement input length limits and security checks
- [ ] Process and store content (AC: 3, 4, 5)
  - [ ] Use existing API infrastructure for processing
  - [ ] Format content for AutoGen analysis
  - [ ] Store using existing database and caching
- [ ] Add error handling and security (AC: 7, 9)
  - [ ] Integrate with existing error handling
  - [ ] Maintain existing security and session management
- [ ] Connect to AutoGen debates (AC: 8, 10)
  - [ ] Trigger debates with signal context
  - [ ] Optimize formatting for agent conversations

## Dev Notes

### Relevant Source Tree Info
- `/src/app/` - Existing dashboard UI component patterns ✅ VERIFIED
- `/src/lib/fact-check/web-search-service.ts` - Content filtering patterns ✅ VERIFIED
- `/src/app/api/` - API infrastructure and authentication systems ✅ VERIFIED
- `/src/shared/lib/api/video-insights.ts` - Content formatting utilities ✅ VERIFIED
- Clerk authentication system ✅ VERIFIED

### AutoGen Integration Architecture
**TECHNICAL SPECIFICATIONS:**
- **AutoGen Framework**: Microsoft AutoGen 0.2+ with GroupChat conversation management
- **Agent Implementation**: Convert existing `/src/domains/ai-agents/` to AutoGen ConversableAgent classes
- **Message Flow**: Text input → relevance validation → AutoGen GroupChat → WebSocket stream
- **Integration Point**: `/api/content/text` → AutoGen conversation → Real-time dashboard display
- **Context Enhancement**: Combine text analysis with current Gayed signal state for agent context

**Direct Input Processing Pipeline:**
```typescript
interface TextAnalysisRequest {
  content: string; // User-provided text (max 10,000 characters)
  userId: string; // Clerk authentication
  analysisType: 'QUICK' | 'COMPREHENSIVE' | 'GAYED_FOCUSED';
  includeSignalContext: boolean;
}

interface TextAnalysisResponse {
  success: boolean;
  data: {
    textId: string;
    relevanceScore: number;
    financialCategories: FinancialCategory[];
    autoGenConversation: {
      conversationId: string;
      agentResponses: AgentMessage[];
      consensus: string;
      confidenceScore: number;
    };
    processingMetrics: {
      validationTime: number;
      conversationTime: number;
      totalProcessingTime: number;
    };
  };
}
```

### Direct Input Interface Design
- Simple, professional text area component
- Real-time character count and validation feedback
- Clear submission and processing status indicators
- Integration with existing dashboard styling

### Content Validation Requirements
- Financial relevance detection
- Malicious content prevention
- Appropriate length limits (not too short/long)
- Text quality validation for meaningful analysis

### Key Constraints
- Must use existing dashboard component patterns
- Security validation essential for direct text input
- Content must be formatted optimally for AutoGen agents
- Integration with existing session and authentication systems

### Performance & Security Specifications
**Performance Requirements:**
- Text relevance validation: <500ms for 5,000 characters
- AutoGen conversation: <30s for 6-round agent debate
- UI responsiveness: Real-time typing feedback, <100ms input lag
- Memory efficiency: <50MB per text analysis session

**Security & Input Validation:**
```typescript
interface TextSecurityValidation {
  maxLength: 10000; // Character limit
  allowedFormats: ['plain-text', 'markdown'];
  blockedPatterns: RegExp[]; // XSS, injection attempts
  contentFiltering: {
    profanityFilter: boolean;
    spamDetection: boolean;
    phishingDetection: boolean;
  };
}

// Security implementation
const validateTextInput = (text: string): ValidationResult => {
  // XSS prevention
  const sanitized = DOMPurify.sanitize(text);

  // Length validation
  if (text.length > 10000) throw new Error('TEXT_TOO_LONG');

  // Pattern matching for malicious content
  const maliciousPatterns = [/<script/i, /javascript:/i, /data:text\/html/i];
  const hasMaliciousContent = maliciousPatterns.some(pattern => pattern.test(text));

  return { isValid: !hasMaliciousContent, sanitizedText: sanitized };
};
```

### Testing Framework
**Comprehensive Testing Strategy:**
- **Unit Tests**: Input validation, relevance scoring, AutoGen agent mocking
- **Integration Tests**: Real text → Mock AutoGen → Dashboard display
- **Security Tests**: XSS attempts, injection testing, input sanitization
- **Performance Tests**: Large text processing, concurrent user testing
- **E2E Tests**: Complete workflow with real financial content examples

**Mock AutoGen Implementation:**
```typescript
// Jest mock for AutoGen testing
jest.mock('autogen', () => ({
  ConversableAgent: jest.fn().mockImplementation(() => ({
    generate_reply: jest.fn().mockResolvedValue('Mock financial analysis response')
  })),
  GroupChat: jest.fn().mockImplementation(() => ({
    initiate_chat: jest.fn().mockResolvedValue(mockFinancialConversation)
  }))
}));
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-21 | 1.0 | Initial story creation | John (PM) |

## Dev Agent Record
_(This section is owned by dev-agent and can only be modified by dev-agent)_

## QA Results
_(This section is owned by qa-agent and can only be modified by qa-agent)_