# Story 2.1: unified-content-trigger-system

## Status
Draft

## Story
**As a** system user,
**I want** content processing to automatically trigger relevant AutoGen agent debates through event-driven architecture,
**so that** I receive comprehensive analysis combining content insights with current market signals without circular dependencies.

## Consolidation Note
**UNIFIED**: Merged trigger logic from Stories 2.1, 2.2, 2.3, and 2.4 into single event-driven system to eliminate redundant trigger implementations.

## Acceptance Criteria
1. **EVENT-DRIVEN TRIGGERS**: Content processing publishes "content_ready" events to generic event bus
2. **REACTIVE ORCHESTRATOR**: AutoGen orchestrator subscribes to content events (loose coupling)
3. **UNIFIED TRIGGER LOGIC**: Single system handles Substack, YouTube, and direct text content triggers
4. **SIGNAL CONTEXT INTEGRATION**: Content events include current Gayed signal state as context
5. **MARKET DATA INCLUSION**: Events carry enhanced market client data for agent conversations
6. **ERROR HANDLING**: Event publishing failures handled gracefully with retry mechanisms
7. **AUTHENTICATION PRESERVATION**: Event system maintains existing security throughout workflow
8. **PERFORMANCE MONITORING**: Event trigger performance tracked with existing monitoring
9. **CONVERSATION LINKING**: Content trigger events linked to conversation sessions and export
10. **RATE LIMITING RESPECT**: Event publishing respects existing system constraints
11. **DEPENDENCIES**: Requires Stories 1.6 (WebSocket), 1.5 (Orchestrator), and content processing (2.1-2.3)
12. **NO CIRCULAR DEPENDENCIES**: Event-driven pattern eliminates orchestrator ↔ content circular dependency

## Tasks / Subtasks
- [ ] Implement content trigger system (AC: 1, 2)
  - [ ] Integrate processed content with signal data
  - [ ] Use AutoGen orchestrator for debate initiation
- [ ] Combine content with signal context (AC: 3, 5)
  - [ ] Integrate with existing Gayed signal states
  - [ ] Include market context from enhanced market client
- [ ] Maintain system constraints (AC: 4, 6)
  - [ ] Respect rate limiting and performance monitoring
  - [ ] Implement error handling and graceful degradation
- [ ] Add logging and monitoring (AC: 7, 8)
  - [ ] Store analysis results with conversation logging
  - [ ] Track content processing performance
- [ ] Ensure quality and security (AC: 9, 10)
  - [ ] Produce actionable insights from combined analysis
  - [ ] Maintain security and authentication throughout

## Dev Notes

### **IMPLEMENTATION DEPENDENCIES** ✅ **UNBLOCKED**
✅ **DEPENDENCIES APPROVED**: Epic 1 stories now approved for implementation
- Epic 1.1: AutoGen framework integration - **STATUS: Approved** ✅
- Epic 1.5: Multi-agent conversation orchestrator - **STATUS: Approved** ✅
- Epic 1.2-1.4: Individual agent implementations - **STATUS: Approved** ✅

⚠️ **IMPLEMENTATION SEQUENCE**: Must complete Epic 1.1-1.5 before starting this story

### Relevant Source Tree Info
- AutoGen orchestrator: **PENDING** Epic 1.5 implementation
- `/src/domains/trading-signals/engines/orchestrator.ts` - Signal orchestrator (different from agent orchestrator) ✅ VERIFIED
- `/src/app/api/signals/` - Existing signal calculation API ✅ VERIFIED
- Rate limiting and performance monitoring infrastructure ✅ VERIFIED
- Conversation logging and session management ✅ VERIFIED

### AutoGen Integration Architecture (FUTURE STATE)
**TECHNICAL SPECIFICATIONS:**
- **AutoGen Framework**: Microsoft AutoGen 0.2+ with advanced GroupChat orchestration
- **Trigger Engine**: Event-driven system monitoring content processing completion
- **Agent Coordination**: Multi-agent conversations with dynamic speaker selection
- **Context Integration**: Real-time Gayed signal data + market context + content analysis
- **Response Processing**: AutoGen conversation results merged with signal dashboard

**Trigger System Implementation:**
```typescript
interface ContentTriggerEngine {
  registerTrigger(contentType: ContentType, callback: TriggerCallback): void;
  processContent(content: ProcessedContent): Promise<AutoGenConversation>;
  combineWithSignalContext(conversation: AutoGenConversation, signals: GayedSignals): EnhancedAnalysis;
}

class AutoGenTriggerOrchestrator {
  async triggerAnalysis(content: ProcessedContent): Promise<AnalysisResult> {
    // Combine content with current signal state
    const signalContext = await this.getCurrentSignalState();
    const enhancedPrompt = this.buildContextualPrompt(content, signalContext);

    // Initialize AutoGen conversation
    const conversation = await this.groupChat.initiate_chat({
      message: enhancedPrompt,
      max_turns: 6,
      summary_method: "reflection_with_llm"
    });

    return this.processConversationResult(conversation, signalContext);
  }
}
```

### Content Trigger Design
Trigger system should:
- Automatically initiate debates when content is processed
- Combine content insights with current signal context
- Respect system performance and rate limiting constraints
- Produce comprehensive analysis combining multiple data sources

### Integration Approach
Leverage existing AutoGen orchestrator while adding content context. Must work seamlessly with current signal calculations and market data.

### Key Constraints
- Must respect existing rate limiting and performance constraints
- Error handling and graceful degradation required
- Security and authentication maintained throughout process
- Content analysis must enhance, not replace, existing signal accuracy

### Performance & Monitoring Specifications
**Performance Requirements:**
- Content trigger response: <2s from content completion to AutoGen initiation
- Signal context integration: <500ms to retrieve and format current Gayed signals
- AutoGen conversation: <45s for comprehensive analysis with signal context
- Concurrent processing: Support 10 simultaneous content analyses

**Real-Time Monitoring:**
```typescript
interface TriggerSystemMetrics {
  triggerResponseTime: number; // Time from content ready to AutoGen start
  signalContextRetrievalTime: number; // Time to fetch current signals
  conversationCompletionTime: number; // AutoGen conversation duration
  errorRate: number; // Percentage of failed triggers
  concurrentSessions: number; // Active content analyses
}

// Monitoring implementation
class TriggerMonitor {
  trackTriggerPerformance(contentId: string, metrics: TriggerSystemMetrics): void {
    // Send to monitoring dashboard
    this.metricsCollector.record('content_trigger_performance', {
      contentId,
      ...metrics,
      timestamp: Date.now()
    });

    // Alert on performance degradation
    if (metrics.triggerResponseTime > 3000) {
      this.alerting.send('SLOW_TRIGGER_RESPONSE', { contentId, responseTime: metrics.triggerResponseTime });
    }
  }
}
```

### Testing Framework (Mock AutoGen Implementation)
**Testing Strategy:**
- **Mock AutoGen Setup**: Complete AutoGen framework simulation for testing
- **Signal Integration Tests**: Verify current signal data integration with content context
- **Performance Tests**: Load testing with multiple concurrent trigger events
- **Error Handling**: Network failures, AutoGen timeouts, signal data unavailability
- **End-to-End Simulation**: Content processing → Mock trigger → Mock conversation → Dashboard

**Mock Implementation:**
```typescript
// Comprehensive AutoGen mock for testing
class MockAutoGenFramework {
  async simulateConversation(prompt: string, signalContext: GayedSignals): Promise<MockConversation> {
    return {
      agents: ['FinancialAnalyst', 'MarketContext', 'RiskChallenger'],
      messages: this.generateMockFinancialDebate(prompt, signalContext),
      consensus: this.calculateMockConsensus(),
      duration: Math.random() * 30000 + 15000, // 15-45s simulation
      confidence: Math.floor(Math.random() * 30) + 70 // 70-100% confidence
    };
  }
}
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | John (PM) |

## Dev Agent Record
_(This section is owned by dev-agent and can only be modified by dev-agent)_

## QA Results
_(This section is owned by qa-agent and can only be modified by qa-agent)_