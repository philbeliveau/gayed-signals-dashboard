# Story 2.9: Authentication Security Hotfix - Fix Route Authorization Bypass Vulnerabilities

## Status

**Draft**

---

## Story

**As a** system administrator and security officer,
**I want** all API routes to enforce Clerk authentication before processing any requests,
**so that** unauthorized users cannot bypass security controls and access protected financial data or services.

---

## Context

### Discovery
During FastAPI MCP authentication testing (Test Results: 2025-10-01), QA discovered **4 critical authentication bypass vulnerabilities** affecting 28.6% of protected API routes (4 of 14 routes failing security validation).

### Current State
- **10 routes correctly enforce auth**: Return 401 Unauthorized without valid Clerk tokens
- **4 routes bypass auth controls**: Allow processing without authentication or validate requests before checking auth
- **Test Pass Rate**: 71.4% (Target: 100%)

### Business Impact
- **Critical Security Risk**: Unauthorized access to financial analysis, conversation data, and content processing
- **Compliance Violation**: Fails financial-grade data integrity requirements (CLAUDE.md)
- **Partnership Blocker**: Cannot demonstrate to Croesus (19,000 users, $2T AUM) without 100% auth enforcement
- **Production Readiness**: Blocks deployment to production environment

---

## Acceptance Criteria

### Functional Requirements

**AC1: Fix POST /api/content/unified Auth Bypass**
- Route returns 401 Unauthorized when userId is null (no Clerk token)
- Route does NOT use `effectiveUserId = userId || 'dev-user'` fallback pattern
- Route returns 401 BEFORE parsing request body or validating content

**AC2: Fix GET /api/conversations/{id}/stream Auth Bypass**
- Route returns 401 Unauthorized when userId is null after auth() try-catch
- Route includes explicit `if (!userId) return 401` check
- Route returns 401 BEFORE providing WebSocket connection information

**AC3: Fix POST /api/conversations/{id}/stream Validation Order**
- Route checks authentication BEFORE parsing request body
- Route returns 401 for missing auth BEFORE returning 400 for missing content
- Route follows "auth-first, validate-second" pattern

**AC4: Fix POST /api/simple-youtube Validation Order**
- Route checks authentication BEFORE parsing request body
- Route returns 401 for missing auth BEFORE returning 400 for missing youtube_url
- Route follows "auth-first, validate-second" pattern

### Security Validation Requirements

**AC5: 100% FastAPI MCP Test Pass Rate**
- All 14 protected routes return 401 Unauthorized without Clerk tokens
- `test_unauthorized_access` shows `"success_rate": "100.0%"`
- `test_all_routes_summary` shows all routes with `"auth_enforced": true`
- Zero routes bypass authentication controls

**AC6: Auth-First Pattern Compliance**
- All API routes check authentication before any request processing
- Auth check occurs before parsing request body
- Auth check occurs before validating request parameters
- Auth check occurs before accessing any external services

### Quality Requirements

**AC7: Maintain Graceful Degradation**
- Routes continue to use try-catch pattern for auth() when Clerk middleware disabled
- Development mode logging (`⚠️ Clerk auth not available`) preserved
- No 500 errors when Clerk service unavailable (verified by test_dev_mode_fallback)

**AC8: Documentation and Standards**
- Coding standards updated with "Auth-First Validation Pattern" section
- Pattern documented: Check authentication → Parse body → Validate parameters → Process request
- QA test results updated showing 100% pass rate

---

## Tasks / Subtasks

### Priority 1: Critical Security Fixes (Must Complete First)

- [ ] **Task 1: Fix POST /api/content/unified (AC1)**
  - [ ] Remove line 69: `const effectiveUserId = userId || 'dev-user'`
  - [ ] Add after line 66 (after auth try-catch): `if (!userId) return NextResponse.json({ success: false, error: 'Unauthorized - Authentication required' }, { status: 401 })`
  - [ ] Verify route returns 401 before processing content
  - [ ] **CRITICAL: Test endpoint with FastAPI MCP after fix:** `curl localhost:8001/test/specific-route -d '{"method":"POST","path":"/api/content/unified"}'`
  - [ ] **Verify test result shows:** `"status_code": 401, "passed": true`

- [ ] **Task 2: Fix GET /api/conversations/{id}/stream (AC2)**
  - [ ] Add after line 43 (after auth try-catch): `if (!userId) return NextResponse.json({ error: 'Unauthorized - Authentication required' }, { status: 401 })`
  - [ ] Verify route returns 401 before providing WebSocket URLs
  - [ ] **CRITICAL: Test endpoint with FastAPI MCP after fix:** `curl localhost:8001/test/specific-route -d '{"method":"GET","path":"/api/conversations/{conversation_id}","conversation_id":"test_123"}'`
  - [ ] **Verify test result shows:** `"status_code": 401, "passed": true`

### Priority 2: Fix Validation Order (Must Complete Second)

- [ ] **Task 3: Fix POST /api/conversations/{id}/stream (AC3)**
  - [ ] Move auth check block to line 78 (BEFORE line 80 body parsing)
  - [ ] Ensure auth check occurs before `await request.json()`
  - [ ] Verify 401 returned before 400 validation errors
  - [ ] **CRITICAL: Test endpoint with FastAPI MCP after fix:** `curl localhost:8001/test/specific-route -d '{"method":"POST","path":"/api/conversations/{conversation_id}/stream","conversation_id":"test_123"}'`
  - [ ] **Verify test result shows:** `"status_code": 401` (NOT 400), `"passed": true`

- [ ] **Task 4: Fix POST /api/simple-youtube (AC4)**
  - [ ] Move auth check block to line 37 (BEFORE line 52 body parsing)
  - [ ] Ensure auth check occurs before `await request.json()`
  - [ ] Ensure auth check occurs before youtube_url validation (line 62)
  - [ ] Verify 401 returned before 400 validation errors
  - [ ] **CRITICAL: Test endpoint with FastAPI MCP after fix:** `curl localhost:8001/test/specific-route -d '{"method":"POST","path":"/api/simple-youtube"}'`
  - [ ] **Verify test result shows:** `"status_code": 401` (NOT 400), `"passed": true`

### Validation and Testing

- [ ] **Task 5: Run Comprehensive FastAPI MCP Tests (AC5) - MANDATORY AFTER TASKS 1-4**
  - [ ] Ensure Next.js dev server running: `cd apps/web && npm run dev`
  - [ ] Ensure FastAPI MCP tester running: `cd apps/backend && uvicorn mcp_auth_tester:app --port 8001`
  - [ ] **CRITICAL: Run unauthorized access test:** `curl localhost:8001/test/unauthorized-access | python3 -m json.tool`
  - [ ] **MUST VERIFY:** `"success_rate": "100.0%"` and `"all_passed": true` (NOT 71.4%)
  - [ ] **CRITICAL: Run all routes summary:** `curl localhost:8001/test/all-routes-summary | python3 -m json.tool`
  - [ ] **MUST VERIFY:** All 14 routes show `"auth_enforced": true, "icon": "✅"` (zero routes with ❌)
  - [ ] Document results in TEST-RESULTS-SUMMARY.md
  - [ ] **DO NOT proceed to Tasks 9-10 until Task 5 shows 100% pass rate**

- [ ] **Task 6: Verify Graceful Degradation (AC7)**
  - [ ] Run dev mode fallback test: `curl localhost:8001/test/dev-mode-fallback`
  - [ ] Confirm all routes return 401 without crashing
  - [ ] Verify console logs show `⚠️ Clerk auth not available` warnings
  - [ ] Confirm zero 500 errors in test results

### Documentation

- [ ] **Task 7: Update Coding Standards (AC8)**
  - [ ] Add "Auth-First Validation Pattern" section to `docs/architecture/coding-standards.md`
  - [ ] Document correct pattern: Auth check → Parse body → Validate params → Process
  - [ ] Document anti-pattern: Parse body first (security risk)
  - [ ] Provide code examples of correct implementation

- [ ] **Task 8: Update Test Documentation**
  - [ ] Update TEST-RESULTS-SUMMARY.md with hotfix test results
  - [ ] Document 100% MCP test pass rate achievement
  - [ ] Record fix application date and validation results

### Real-World Content Testing

- [ ] **Task 9: Enhance MCP Server for Real Content Testing**
  - [ ] Add `custom_body` parameter to `test_specific_route` in `apps/backend/mcp_auth_tester.py`
  - [ ] Allow passing custom JSON payloads for real content testing
  - [ ] Update MCP server to accept real Substack URLs, YouTube URLs, and text content

- [ ] **Task 10: Validate Auth with Real Content Payloads (AC1, AC4)**
  - [ ] Test POST /api/content/unified with real text content (must return 401 without auth)
  - [ ] Test POST /api/simple-youtube with real YouTube URL (must return 401 without auth)
  - [ ] Test POST /api/content/substack with real Substack URL (must return 401 without auth)
  - [ ] **All tests must use FastAPI MCP** (NOT direct curl to Next.js)
  - [ ] Document that auth enforcement works with real-world content payloads

**Task 9 Implementation: Enhance MCP test_specific_route**

Update `apps/backend/mcp_auth_tester.py` - modify the `test_specific_route` function (starting at line 334):

```python
@app.get("/test/specific-route", operation_id="test_specific_route")
async def test_specific_route(
    method: str = Query(description="HTTP method (GET, POST, PATCH, DELETE)"),
    path: str = Query(description="API route path (e.g., /api/conversations)"),
    conversation_id: Optional[str] = Query(default=None, description="Conversation ID if needed"),
    clerk_token: Optional[str] = Query(default=None, description="Clerk session token (optional)"),
    custom_body: Optional[str] = Query(default=None, description="Custom JSON body for testing (JSON string)")  # ADD THIS
):
    """
    Test a specific route with optional Clerk authentication and custom request body.
    Useful for debugging individual endpoint auth behavior with real content.
    """
    # Replace conversation_id in path if provided
    if conversation_id and "{conversation_id}" in path:
        path = path.replace("{conversation_id}", conversation_id)

    url = f"{NEXTJS_BASE_URL}{path}"

    # Find route config for body if needed
    route_config = next(
        (r for r in PROTECTED_ROUTES if r["path"] == path and r["method"] == method),
        None
    )

    headers = {}
    if clerk_token:
        headers["Authorization"] = f"Bearer {clerk_token}"

    try:
        async with httpx.AsyncClient(timeout=10.0) as client:
            request_kwargs = {"method": method, "url": url, "headers": headers}

            # Use custom body if provided, otherwise use default route body
            if custom_body:
                import json
                try:
                    request_kwargs["json"] = json.loads(custom_body)  # ADD THIS
                except json.JSONDecodeError as e:
                    return {
                        "route": f"{method} {path}",
                        "error": f"Invalid JSON in custom_body: {str(e)}",
                        "timestamp": datetime.utcnow().isoformat()
                    }
            elif route_config and route_config.get("requires_body"):
                request_kwargs["json"] = route_config["body"]

            response = await client.request(**request_kwargs)

            return {
                "route": f"{method} {path}",
                "status_code": response.status_code,
                "has_auth_token": clerk_token is not None,
                "expected_with_auth": 200 if clerk_token else 401,
                "response_preview": response.text[:500],
                "headers": dict(response.headers),
                "timestamp": datetime.utcnow().isoformat()
            }

    except Exception as e:
        return {
            "route": f"{method} {path}",
            "error": str(e),
            "has_auth_token": clerk_token is not None,
            "timestamp": datetime.utcnow().isoformat()
        }
```

**Note:** FastAPI MCP automatically exposes this endpoint as an MCP tool with the `operation_id="test_specific_route"`. The Query parameters become tool parameters accessible via MCP Inspector or Claude Desktop.

**Security Note:** The MCP auth tester does NOT require MCP authentication (no `auth_config`) because:
- It's a local development/QA tool, not a production API
- It tests **Next.js API auth**, not its own auth
- Tests are read-only operations with no data modification
- Access is controlled at network level (localhost, VPN if exposed)
- Adding MCP auth would complicate testing workflow unnecessarily

**Task 10 Test Commands (Using Enhanced MCP):**

```bash
# Test 1: Real Text Content (POST /api/content/unified)
curl -X GET "http://localhost:8001/test/specific-route" \
  -H "Content-Type: application/json" \
  -G \
  --data-urlencode 'method=POST' \
  --data-urlencode 'path=/api/content/unified' \
  --data-urlencode 'custom_body={"contentType":"text","content":"U.S. stocks did well in September. The S&P 500, Dow, and Nasdaq all went up in value, and the Dow even set a new record. But the background doesnt look as convincing. Markets may be ahead of fundamentals given weak jobs growth, manufacturing weakness, and stubborn inflation.","analysisType":"QUICK"}'

# Expected Result:
# {
#   "route": "POST /api/content/unified",
#   "status_code": 401,
#   "has_auth_token": false,
#   "expected_with_auth": 401
# }

# Test 2: Real YouTube URL (POST /api/simple-youtube)
curl -X GET "http://localhost:8001/test/specific-route" \
  -H "Content-Type: application/json" \
  -G \
  --data-urlencode 'method=POST' \
  --data-urlencode 'path=/api/simple-youtube' \
  --data-urlencode 'custom_body={"youtube_url":"https://www.youtube.com/watch?v=LvcMLbKPf1Q"}'

# Expected Result:
# {
#   "route": "POST /api/simple-youtube",
#   "status_code": 401,  # NOT 400!
#   "has_auth_token": false,
#   "expected_with_auth": 401
# }

# Test 3: Real Substack URL (POST /api/content/substack)
curl -X GET "http://localhost:8001/test/specific-route" \
  -H "Content-Type: application/json" \
  -G \
  --data-urlencode 'method=POST' \
  --data-urlencode 'path=/api/content/substack' \
  --data-urlencode 'custom_body={"url":"https://substack.com/home/post/p-175035159?source=queue"}'

# Expected Result:
# {
#   "route": "POST /api/content/substack",
#   "status_code": 401,
#   "has_auth_token": false,
#   "expected_with_auth": 401
# }
```

**Why Use MCP Instead of Direct Curl:**
- ✅ Consistent testing interface (all tests go through MCP)
- ✅ Structured JSON responses for validation
- ✅ Can add Clerk tokens easily via `clerk_token` parameter for authenticated testing
- ✅ Automated pass/fail detection
- ✅ Integration with Claude Desktop MCP Inspector for interactive testing

---

## Dev Notes

### Relevant Source Tree

**Files to Modify (4 files):**
1. `apps/web/src/app/api/content/unified/route.ts` (Lines 66-69)
2. `apps/web/src/app/api/conversations/[id]/stream/route.ts` (Lines 21-43 GET, 74-80 POST)
3. `apps/web/src/app/api/simple-youtube/route.ts` (Lines 36-68)

**Testing Infrastructure:**
- `apps/backend/mcp_auth_tester.py` - FastAPI MCP auth testing server (already configured)
- MCP tests accessible via HTTP: `http://localhost:8001/test/*`

**Documentation to Update:**
- `docs/architecture/coding-standards.md` - Add auth-first pattern
- `TEST-RESULTS-SUMMARY.md` - Record 100% pass rate

### Current Auth Pattern (Correct - 10 routes use this)

```typescript
let userId: string | null = null
try {
  const authResult = await auth()
  userId = authResult.userId
} catch (authError) {
  console.log('⚠️ Clerk auth not available - using development mode')
}

if (!userId) {  // ✅ ENFORCES AUTH
  return NextResponse.json(
    { error: 'Unauthorized - Authentication required' },
    { status: 401 }
  )
}

// NOW safe to process request
```

### Anti-Pattern 1: Dev User Fallback (CRITICAL VULNERABILITY)

```typescript
// ❌ VULNERABLE - Found in /api/content/unified
let userId: string | null = null
try {
  userId = (await auth()).userId
} catch (authError) {
  console.log('⚠️ Clerk auth not available - using development mode')
}

const effectiveUserId = userId || 'dev-user'  // ❌ BYPASSES AUTH
// This allows unauthenticated processing - MUST REMOVE
```

### Anti-Pattern 2: Missing Auth Check (CRITICAL VULNERABILITY)

```typescript
// ❌ VULNERABLE - Found in GET /api/conversations/{id}/stream
let userId: string | null = null
try {
  userId = (await auth()).userId
} catch (authError) {
  console.log('⚠️ Clerk auth not available - using development mode')
}

// Missing: if (!userId) return 401
// Route continues execution without auth check - MUST ADD CHECK
```

### Anti-Pattern 3: Validate Before Auth (HIGH SEVERITY)

```typescript
// ❌ WRONG ORDER - Found in POST /api/simple-youtube
export async function POST(request: NextRequest) {
  try {
    let body: YouTubeProcessRequest
    body = await request.json()  // ❌ PARSES BODY FIRST

    if (!body.youtube_url) {  // ❌ VALIDATES BEFORE AUTH
      return NextResponse.json({ error: 'YouTube URL is required' }, { status: 400 })
    }

    // Auth check happens AFTER validation - MUST MOVE AUTH FIRST
```

### Correct Pattern: Auth-First Validation

```typescript
// ✅ CORRECT ORDER
export async function POST(request: NextRequest) {
  try {
    // 1. AUTH CHECK FIRST
    let userId: string | null = null
    try {
      userId = (await auth()).userId
    } catch (authError) {
      console.log('⚠️ Clerk auth not available')
    }

    if (!userId) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // 2. THEN PARSE BODY
    const body = await request.json()

    // 3. THEN VALIDATE PARAMETERS
    if (!body.required_field) {
      return NextResponse.json({ error: 'Field required' }, { status: 400 })
    }

    // 4. FINALLY PROCESS REQUEST
```

### Financial-Grade Data Integrity Context

From `CLAUDE.md`:
- **NO FALLBACK DATA POLICY**: Never use placeholder, synthetic, or mock data in production
- **Explicit Transparency**: Always report when real data sources unavailable
- **Graceful Degradation**: Continue with reduced capability, never fabricate data

**Applied to Auth:** Never bypass auth with fallback users (`dev-user`). Return explicit 401 when auth unavailable, maintaining transparency about security state.

### Risk Assessment from QA

| **Vulnerability** | **Impact** | **Exploitation** |
|-------------------|------------|------------------|
| POST /api/content/unified | **CRITICAL** | Anyone can process content without authentication |
| GET /conversations/{id}/stream | **CRITICAL** | Anyone can access WebSocket URLs without authentication |
| POST validation order issues | **HIGH** | Information leakage via validation errors before auth |

---

## Testing

### Test Framework
- **FastAPI MCP Testing**: HTTP-based auth validation via `mcp_auth_tester.py`
- **Test Location**: `apps/backend/mcp_auth_tester.py`
- **Test Execution**: `uvicorn mcp_auth_tester:app --port 8001`

### Required Tests (All Must Pass)

**1. Unauthorized Access Test (AC5)**
```bash
curl -X GET "http://localhost:8001/test/unauthorized-access?test_conversation_id=test_conv_123"
```
**Expected Result:**
```json
{
  "test_name": "Unauthorized Access Test",
  "total_routes": 14,
  "passed": 14,
  "failed": 0,
  "success_rate": "100.0%",
  "all_passed": true
}
```

**2. All Routes Summary Test (AC5)**
```bash
curl -X GET "http://localhost:8001/test/all-routes-summary?test_conversation_id=test_conv_123"
```
**Expected Result:** All 14 routes show:
```json
{
  "endpoint": "METHOD /api/route",
  "status": 401,
  "auth_enforced": true,
  "icon": "✅"
}
```

**3. Dev Mode Fallback Test (AC7)**
```bash
curl -X GET "http://localhost:8001/test/dev-mode-fallback"
```
**Expected Result:** All routes return 401 without 500 errors

**4. Specific Route Tests (AC1-4)**
Test each fixed route individually:
```bash
# Test POST /api/content/unified
curl -X GET "http://localhost:8001/test/specific-route" \
  -H "Content-Type: application/json" \
  -d '{"method":"POST","path":"/api/content/unified"}'

# Test GET /api/conversations/{id}/stream
curl -X GET "http://localhost:8001/test/specific-route" \
  -H "Content-Type: application/json" \
  -d '{"method":"GET","path":"/api/conversations/{conversation_id}","conversation_id":"test_123"}'

# Test POST /api/conversations/{id}/stream
curl -X GET "http://localhost:8001/test/specific-route" \
  -H "Content-Type: application/json" \
  -d '{"method":"POST","path":"/api/conversations/{conversation_id}/stream","conversation_id":"test_123"}'

# Test POST /api/simple-youtube
curl -X GET "http://localhost:8001/test/specific-route" \
  -H "Content-Type: application/json" \
  -d '{"method":"POST","path":"/api/simple-youtube"}'
```
**Expected:** All return `"status_code": 401`

### Test Standards
- **Auth enforcement**: 100% of routes must return 401 without valid Clerk tokens
- **Error ordering**: Auth failures (401) must occur before validation failures (400)
- **Graceful degradation**: No 500 errors when Clerk service unavailable
- **Consistency**: All routes follow identical auth-first pattern

### Definition of Done - Testing Checklist

**MANDATORY: Every code change MUST be tested with FastAPI MCP before marking complete:**

- [ ] **Each individual fix tested immediately with FastAPI MCP** (Tasks 1-4)
- [ ] **All FastAPI MCP tests pass with 100% success rate** (Task 5 - MANDATORY GATE)
- [ ] **MCP server enhanced for real content testing** (Task 9 - add `custom_body` parameter)
- [ ] **Real-world content testing validates auth enforcement** (Task 10 - MANDATORY)
- [ ] All 14 routes return 401 for unauthorized requests (verified by MCP)
- [ ] All 4 fixed routes validated individually (verified by MCP)
- [ ] Dev mode fallback test passes without 500 errors (verified by MCP)
- [ ] Real text content, YouTube URL, and Substack URL all return 401 without auth (via MCP)
- [ ] Test results documented in TEST-RESULTS-SUMMARY.md

**CRITICAL REMINDER FOR DEV AGENT:**
- ❌ **DO NOT skip FastAPI MCP testing** - it is not optional
- ❌ **DO NOT skip Task 9** (MCP enhancement) - needed for real content testing
- ❌ **DO NOT skip Task 10** (real-world content validation) - tests with actual Substack, YouTube, text
- ❌ **DO NOT use direct curl to Next.js** - all tests MUST go through FastAPI MCP
- ❌ **DO NOT assume fixes work** - always verify with MCP tests
- ❌ **DO NOT mark story complete** until `test_unauthorized_access` shows 100.0% success rate
- ✅ **ALWAYS test each endpoint immediately after fixing it** (Tasks 1-4)
- ✅ **ALWAYS run comprehensive tests (Task 5) after Tasks 1-4 complete**
- ✅ **ALWAYS enhance MCP server (Task 9) before real content testing (Task 10)**
- ✅ **ALWAYS test with real content via MCP (Task 10) to validate production readiness**

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-01 | 1.0 | Initial story creation based on QA FastAPI MCP test findings | John (PM) |
| 2025-10-01 | 1.1 | Added CRITICAL testing emphasis to all tasks - FastAPI MCP testing mandatory after each fix | John (PM) |
| 2025-10-01 | 1.2 | Added Task 9: Real-world content testing with actual Substack, YouTube, and text payloads | John (PM) |
| 2025-10-01 | 1.3 | Updated Tasks 9-10: Enhanced MCP server with `custom_body` parameter for real content testing via MCP (not direct curl) | John (PM) |

---

## Dev Agent Record

*(To be populated by Dev Agent during implementation)*

### Agent Model Used

*(Dev Agent will record model used)*

### Debug Log References

*(Dev Agent will record debug logs)*

### Completion Notes List

*(Dev Agent will record completion notes)*

### File List

*(Dev Agent will record all files modified)*

---

## QA Results

*(To be populated by QA Agent after implementation)*
